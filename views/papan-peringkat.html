<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papan Peringkat - Daulah Abbasiyah</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">Daulah Abbasiyah</div>
            <div class="hamburger" id="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <ul class="nav-links" id="navLinks">
                <li><a href="/index.html">Beranda</a></li>
                <li><a href="/timeline.html">Timeline</a></li>
                <li><a href="/infografis.html">Infografis</a></li>
                <li><a href="/tokoh.html">Tokoh</a></li>
                <li><a href="/uji-kemampuan.html">Kuis</a></li>
                <li><a href="/papan-peringkat.html">Peringkat</a></li>
                <li><a href="/about.html">Tentang</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero">
            <h1>Papan Peringkat Teratas</h1>
            <p>Berikut adalah daftar para pembelajar dengan skor tertinggi. Teruslah belajar untuk mencapai puncak!</p>
        </section>

        <div class="leaderboard">
            <h2>Ranking Peserta</h2>
            <table id="leaderboardTable">
                <thead>
                    <tr>
                        <th>Peringkat</th>
                        <th>Nama Pengguna</th>
                        <th>Skor</th>
                        <th>Tanggal & Waktu</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <!-- Data will be populated by JavaScript -->
                    <tr>
                        <td colspan="4" style="text-align: center;">Memuat data...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="btn-container">
            <a href="/uji-kemampuan.html" class="btn-lanjutkan">Coba Lagi</a>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Website Pembelajaran Daulah Abbasiyah. Hak Cipta Dilindungi.</p>
        <p>Dibuat oleh Diah Iskamtini untuk tujuan pendidikan</p>
    </footer>

    <script src="/js/common.js"></script>
    <script>
        const JAKARTA_TIME_ZONE = 'Asia/Jakarta';

        function normalizeTimestamp(timestamp) {
            if (!timestamp) {
                return null;
            }
            if (timestamp instanceof Date) {
                return timestamp;
            }
            if (typeof timestamp === 'number') {
                return new Date(timestamp);
            }
            if (typeof timestamp === 'string') {
                const trimmed = timestamp.trim();
                if (trimmed.endsWith('Z') || trimmed.includes('+')) {
                    return new Date(trimmed);
                }
                if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(trimmed)) {
                    return new Date(trimmed.replace(' ', 'T') + 'Z');
                }
                return new Date(trimmed);
            }
            return null;
        }

        function formatTimestampToJakarta(timestamp) {
            const date = normalizeTimestamp(timestamp);
            if (!date || Number.isNaN(date.getTime())) {
                return '-';
            }
            return new Intl.DateTimeFormat('id-ID', {
                timeZone: JAKARTA_TIME_ZONE,
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).format(date);
        }

        // Fetch leaderboard data from API
        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/scores');

                if (!response.ok) {
                    throw new Error('Gagal mengambil data dari server');
                }

                const scores = await response.json();

                const tbody = document.getElementById('leaderboardBody');
                tbody.innerHTML = '';

                // Validate scores is an array
                if (!Array.isArray(scores) || scores.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Belum ada data. Jadilah yang pertama!</td></tr>';
                    return;
                }

                scores.forEach((score, index) => {
                    const row = document.createElement('tr');
                    const rank = index + 1;

                    // Add special class for top 3
                    if (rank === 1) row.classList.add('rank-1');
                    else if (rank === 2) row.classList.add('rank-2');
                    else if (rank === 3) row.classList.add('rank-3');

                    const formattedDate = formatTimestampToJakarta(score.timestamp);

                    row.innerHTML = `
                        <td>${rank}</td>
                        <td>${score.name}</td>
                        <td>${score.score}/10</td>
                        <td>${formattedDate}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                const tbody = document.getElementById('leaderboardBody');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Gagal memuat data.</td></tr>';
            }
        }

        // Load leaderboard when page loads
        window.addEventListener('DOMContentLoaded', loadLeaderboard);
    </script>
</body>
</html>
